<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0f0f0f">
  <title>ğŸ›’ Need to Buy</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { background: #0f0f0f; color: #fff; font-family: 'Nunito', 'Trebuchet MS', sans-serif; min-height: 100vh; user-select: none; }
    button { font-family: inherit; }
    input, textarea { font-family: inherit; outline: none; }

    /* Header */
    #header { display: flex; align-items: center; justify-content: space-between; padding: 18px 20px 12px; border-bottom: 1px solid #1a1a1a; position: sticky; top: 0; background: #0f0f0f; z-index: 10; }
    #header-left h1 { font-size: 22px; font-weight: 900; letter-spacing: -0.5px; }
    #header-left p { font-size: 12px; color: #555; margin-top: 2px; }
    #header-right { display: flex; gap: 7px; }
    .hbtn { border: none; border-radius: 10px; padding: 8px 13px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s; }

    /* Edit banner */
    #edit-banner { background: #1a1000; border-bottom: 1px solid #3a2800; padding: 8px 20px; font-size: 12px; color: #f97316; display: none; align-items: center; justify-content: space-between; }
    #edit-banner.visible { display: flex; }
    #export-btn { background: #2a1800; border: 1px solid #f97316; border-radius: 8px; padding: 5px 10px; color: #f97316; font-size: 12px; font-weight: 700; cursor: pointer; }

    /* Sync indicator */
    #sync-bar { background: #0a1a0a; border-bottom: 1px solid #1a3a1a; padding: 5px 20px; font-size: 11px; color: #22c55e; display: none; }
    #sync-bar.visible { display: block; }

    /* Views */
    .view { display: none; padding: 14px 18px; }
    .view.active { display: block; }

    /* Grid */
    .cat-section { margin-bottom: 24px; }
    .cat-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 9px; }
    .cat-label { font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; }
    .cat-edit-btns { display: none; gap: 5px; }
    .edit-mode .cat-edit-btns { display: flex; }
    .cat-edit-btn { background: #1c1c1c; border: none; border-radius: 7px; padding: 5px 9px; font-size: 15px; cursor: pointer; line-height: 1; }

    .tiles { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .tile-wrap { position: relative; }
    .tile {
      width: 100%; background: #1c1c1c; border: 2px solid #252525; border-radius: 14px;
      padding: 16px 10px; color: #666; font-size: 13px; font-weight: 600; cursor: pointer;
      text-align: center; transition: all 0.13s ease; line-height: 1.3; display: flex;
      align-items: center; justify-content: center; gap: 5px; min-height: 58px;
    }
    .tile.active { color: #fff; font-weight: 800; border-color: transparent; }
    .tile.tapped { transform: scale(0.91); }
    .tile-icon-btn {
      position: absolute; bottom: 4px; background: rgba(30,30,30,0.92);
      border: none; border-radius: 6px; width: 26px; height: 26px;
      font-size: 12px; cursor: pointer; display: none; align-items: center; justify-content: center;
    }
    .tile-edit { left: 4px; color: #ccc; }
    .tile-del  { right: 4px; color: #ef4444; }
    .edit-mode .tile-icon-btn { display: flex; }

    .add-item-btn { background: none; border: 2px dashed #252525; border-radius: 12px; padding: 12px 18px; color: #3a3a3a; font-size: 13px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 2px; }

    /* List view */
    .list-item { display: flex; align-items: center; justify-content: space-between; background: #181818; border-radius: 11px; padding: 12px 14px; margin-bottom: 6px; }
    .list-item-name { color: #eee; font-size: 14px; }
    .list-item-cat { color: #3a3a3a; font-size: 11px; margin-top: 2px; }
    .got-it-btn { background: #252525; border: none; border-radius: 7px; padding: 5px 10px; color: #888; cursor: pointer; font-size: 11px; }

    /* Send view */
    .send-card { background: #181818; border-radius: 16px; padding: 18px; }
    .send-section { margin-bottom: 12px; }
    .send-cat-label { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
    .send-item-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #222; color: #ccc; font-size: 13px; }
    .send-remove { background: none; border: none; color: #3a3a3a; cursor: pointer; font-size: 14px; }
    .send-email-label { font-size: 11px; color: #444; display: block; margin: 14px 0 5px; }
    .send-email-input { width: 100%; background: #111; border: 1px solid #252525; border-radius: 9px; padding: 10px 13px; color: #fff; font-size: 14px; margin-bottom: 12px; }
    .send-btn { width: 100%; background: #22c55e; border: none; border-radius: 11px; padding: 13px; color: #fff; font-size: 15px; font-weight: 800; cursor: pointer; }
    .back-btn { background: none; border: none; color: #777; font-size: 13px; cursor: pointer; margin-bottom: 12px; }

    /* Overlay / Sheet */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.88); display: flex; align-items: flex-end; z-index: 200; }
    .sheet { background: #161616; border-radius: 22px 22px 0 0; padding: 22px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .sheet-title { font-size: 16px; font-weight: 800; margin-bottom: 16px; }
    .sheet-label { font-size: 11px; color: #555; display: block; margin-bottom: 6px; }
    .sheet-input { width: 100%; background: #0f0f0f; border: 1px solid #252525; border-radius: 9px; padding: 11px 13px; color: #fff; font-size: 15px; margin-bottom: 16px; }
    .sheet-textarea { width: 100%; background: #0a0a0a; border: 1px solid #252525; border-radius: 9px; padding: 11px 13px; color: #888; font-size: 11px; font-family: monospace; height: 200px; resize: none; }
    .sheet-btns { display: flex; gap: 8px; margin-top: 12px; }
    .btn-secondary { flex: 1; background: #1c1c1c; border: none; border-radius: 11px; padding: 13px; color: #888; font-size: 14px; cursor: pointer; }
    .btn-primary   { flex: 2; border: none; border-radius: 11px; padding: 13px; color: #fff; font-size: 14px; font-weight: 800; cursor: pointer; }
    .btn-danger    { flex: 2; background: #ef4444; border: none; border-radius: 11px; padding: 13px; color: #fff; font-size: 14px; font-weight: 800; cursor: pointer; }

    /* Cat chips */
    .cat-chips { display: flex; flex-wrap: wrap; gap: 7px; margin-bottom: 18px; }
    .cat-chip { border: 2px solid #252525; border-radius: 8px; padding: 6px 12px; color: #666; font-size: 12px; font-weight: 700; cursor: pointer; background: #1c1c1c; }
    .cat-chip.selected { border-color: transparent; color: #fff; }
    .cat-chip-new { background: none; border: 2px dashed #252525; border-radius: 8px; padding: 6px 12px; color: #444; font-size: 12px; font-weight: 700; cursor: pointer; }

    /* Emoji / palette pickers */
    .emoji-grid { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 16px; }
    .emoji-btn { background: none; border: 2px solid transparent; border-radius: 7px; padding: 4px 7px; font-size: 19px; cursor: pointer; }
    .emoji-btn.selected { background: #2a2a2a; border-color: #555; }
    .palette-grid { display: flex; flex-wrap: wrap; gap: 7px; margin-bottom: 16px; }
    .swatch { width: 30px; height: 30px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; }
    .swatch.selected { border-color: #fff; }
    .cat-preview { border-radius: 9px; padding: 9px 13px; margin-bottom: 18px; }

    /* Delete confirm list */
    .delete-preview { background: #0f0f0f; border-radius: 10px; padding: 10px 14px; margin-bottom: 18px; }
    .delete-preview-item { font-size: 12px; color: #555; padding: 2px 0; }
  </style>
</head>
<body>

<!-- HEADER -->
<div id="header">
  <div id="header-left">
    <h1>ğŸ›’ Need to Buy</h1>
    <p id="count-label">All stocked up!</p>
  </div>
  <div id="header-right">
    <button class="hbtn" id="edit-toggle-btn" style="background:#1a1a1a;color:#666;" onclick="toggleEditMode()">âœï¸ Edit</button>
    <button class="hbtn" id="view-toggle-btn" style="background:#1a1a1a;color:#777;font-size:16px;" onclick="toggleView()">â‰¡</button>
    <button class="hbtn" id="send-btn" style="background:#1a1a1a;color:#444;" onclick="showView('send')">ğŸ“§ Send</button>
  </div>
</div>

<!-- EDIT BANNER -->
<div id="edit-banner">
  <span>âœï¸ Tap âœï¸ to rename, ğŸ—‘ to delete.</span>
  <button id="export-btn" onclick="openExport()">ğŸ“¤ Export</button>
</div>

<!-- SYNC BAR -->
<div id="sync-bar">âš¡ Live sync active â€” changes appear on all devices instantly</div>

<!-- GRID VIEW -->
<div id="grid-view" class="view active">
  <div id="categories-container"></div>
  <button class="add-item-btn" onclick="openAddItem()">+ Add item or category</button>
</div>

<!-- LIST VIEW -->
<div id="list-view" class="view">
  <h2 style="font-size:16px;font-weight:800;margin-bottom:12px;" id="list-title">Shopping List</h2>
  <div id="list-container"></div>
</div>

<!-- SEND VIEW -->
<div id="send-view" class="view">
  <button class="back-btn" onclick="showView('grid')">â† Back</button>
  <div class="send-card">
    <h2 style="font-size:16px;font-weight:800;margin-bottom:12px;">Review & Send</h2>
    <div id="send-list-container"></div>
    <label class="send-email-label">Send to</label>
    <input class="send-email-input" id="email-input" type="email" placeholder="you@example.com">
    <button class="send-btn" onclick="openMailto()">ğŸ“§ Open in email app</button>
    <p style="margin-top:8px;color:#444;text-align:center;font-size:11px;">Opens your email app with the list pre-filled.</p>
  </div>
</div>

<!-- â•â• MODALS â•â• -->

<!-- Add Item -->
<div class="overlay" id="modal-addItem" style="display:none" onclick="overlayClick(event,'modal-addItem')">
  <div class="sheet">
    <div class="sheet-title">Add items</div>
    <label class="sheet-label">Separate multiple items with commas</label>
    <input class="sheet-input" id="new-item-input" placeholder="e.g. Oat milk, Yoghurt, Butter" oninput="updateAddBtn()" onkeydown="if(event.key==='Enter')confirmAddItem()">
    <label class="sheet-label">Category</label>
    <div class="cat-chips" id="cat-chips-container"></div>
    <div class="sheet-btns">
      <button class="btn-secondary" onclick="closeModal('modal-addItem')">Cancel</button>
      <button class="btn-primary" id="add-item-confirm-btn" style="background:#1c1c1c;color:#333;" onclick="confirmAddItem()">Add âœ“</button>
    </div>
  </div>
</div>

<!-- New / Edit Category -->
<div class="overlay" id="modal-editCat" style="display:none" onclick="overlayClick(event,'modal-editCat')">
  <div class="sheet">
    <div class="sheet-title" id="cat-modal-title">New Category</div>
    <label class="sheet-label">Name</label>
    <input class="sheet-input" id="cat-name-input" placeholder="e.g. Frozen Foods" oninput="updateCatPreview()" onkeydown="if(event.key==='Enter')confirmCat()">
    <label class="sheet-label">Emoji</label>
    <div class="emoji-grid" id="emoji-grid"></div>
    <label class="sheet-label">Colour</label>
    <div class="palette-grid" id="palette-grid"></div>
    <div class="cat-preview" id="cat-preview"><span id="cat-preview-text"></span></div>
    <div class="sheet-btns">
      <button class="btn-secondary" id="cat-back-btn" onclick="closeModal('modal-editCat')">Cancel</button>
      <button class="btn-primary" id="cat-confirm-btn" onclick="confirmCat()">Create</button>
    </div>
  </div>
</div>

<!-- Edit Item -->
<div class="overlay" id="modal-editItem" style="display:none" onclick="overlayClick(event,'modal-editItem')">
  <div class="sheet">
    <div class="sheet-title">Rename Item</div>
    <label class="sheet-label">Item name</label>
    <input class="sheet-input" id="edit-item-input" oninput="updateEditItemBtn()" onkeydown="if(event.key==='Enter')confirmEditItem()">
    <div class="sheet-btns">
      <button class="btn-secondary" onclick="closeModal('modal-editItem')">Cancel</button>
      <button class="btn-primary" id="edit-item-confirm-btn" style="background:#4ECDC4;" onclick="confirmEditItem()">Save</button>
    </div>
  </div>
</div>

<!-- Delete Category -->
<div class="overlay" id="modal-deleteCat" style="display:none" onclick="overlayClick(event,'modal-deleteCat')">
  <div class="sheet">
    <div class="sheet-title">Delete category?</div>
    <p id="delete-cat-msg" style="font-size:13px;color:#888;margin-bottom:6px;line-height:1.5;"></p>
    <div class="delete-preview" id="delete-cat-preview"></div>
    <div class="sheet-btns">
      <button class="btn-secondary" onclick="closeModal('modal-deleteCat')">Cancel</button>
      <button class="btn-danger" onclick="confirmDeleteCat()">Yes, delete category</button>
    </div>
  </div>
</div>

<!-- Delete Item -->
<div class="overlay" id="modal-deleteItem" style="display:none" onclick="overlayClick(event,'modal-deleteItem')">
  <div class="sheet">
    <div class="sheet-title">Remove item?</div>
    <p id="delete-item-msg" style="font-size:13px;color:#888;margin-bottom:18px;line-height:1.5;"></p>
    <div class="sheet-btns">
      <button class="btn-secondary" onclick="closeModal('modal-deleteItem')">Cancel</button>
      <button class="btn-danger" onclick="confirmDeleteItem()">Yes, remove item</button>
    </div>
  </div>
</div>

<!-- Export -->
<div class="overlay" id="modal-export" style="display:none" onclick="overlayClick(event,'modal-export')">
  <div class="sheet">
    <div class="sheet-title">ğŸ“¤ Export config</div>
    <p style="font-size:12px;color:#555;margin-bottom:12px;">Copy this and paste it to Claude to save as your new defaults.</p>
    <textarea class="sheet-textarea" id="export-textarea" readonly></textarea>
    <div class="sheet-btns">
      <button class="btn-secondary" onclick="closeModal('modal-export')">Close</button>
      <button class="btn-primary" id="copy-btn" style="background:#4ECDC4;" onclick="copyExport()">Copy to clipboard</button>
    </div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCJktZZkiD1rs2t9X2H-Ko-aa3joCIHCiE",
    authDomain: "shopping-list-b1bac.firebaseapp.com",
    databaseURL: "https://shopping-list-b1bac-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "shopping-list-b1bac",
    storageBucket: "shopping-list-b1bac.firebasestorage.app",
    messagingSenderId: "635263766216",
    appId: "1:635263766216:web:7909fb9784f42049069ffd"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // Expose Firebase write/listen to global scope
  window._fbSet = (path, data) => set(ref(db, path), data);
  window._fbListen = (path, cb) => onValue(ref(db, path), snap => cb(snap.val()));

  // Show sync bar once connected
  document.getElementById('sync-bar').classList.add('visible');

  // Boot app after Firebase is ready
  window._fbReady = true;
  if (window._onFbReady) window._onFbReady();
</script>

<script>
// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_CATEGORIES = [
  { id: "pet",       label: "Pet Supplies",    emoji: "ğŸ±", color: "#FF6B6B", items: ["Cat food", "Cat nibbles", "Dog biscuits", "Dog food"] },
  { id: "dairy",     label: "Dairy",           emoji: "ğŸ¥›", color: "#4ECDC4", items: ["Milk", "Yoghurt", "Cheese", "Butter", "Eggs", "Oat milk"] },
  { id: "bread",     label: "Bread & Bakery",  emoji: "ğŸ", color: "#FFD93D", items: ["White bread", "Sourdough", "Crumpets", "Bagels"] },
  { id: "snacks",    label: "Snacks & Drinks", emoji: "ğŸ¿", color: "#A855F7", items: ["Crisps", "Biscuits", "Orange juice", "Squash", "Coffee", "Tea"] },
  { id: "veg",       label: "Vegetables",      emoji: "ğŸ¥¦", color: "#6BCB77", items: ["Broccoli", "Parsnips", "Potatoes", "Cucumber", "Tomatoes", "Cauliflower"] },
  { id: "frozen",    label: "Frozen food",     emoji: "â„ï¸", color: "#4ECDC4", items: ["Chips", "Pizza", "Yorky P"] },
  { id: "tinned",    label: "Tinned food",     emoji: "ğŸ«™", color: "#8B5CF6", items: ["Tinned Toms", "Soup", "Baked beans", "Spag hoops"] },
  { id: "breakfast", label: "Breakfast",       emoji: "ğŸ¥£", color: "#EC4899", items: ["Porridge", "Hoops", "Shreddies"] },
];

const PALETTE = ["#FF6B6B","#FF9F43","#FFD93D","#6BCB77","#4ECDC4","#45B7D1","#A855F7","#EC4899","#F97316","#14B8A6","#8B5CF6","#06B6D4"];
const EMOJIS  = ["ğŸ±","ğŸ¶","ğŸ¥›","ğŸ","ğŸ¿","ğŸ¥¦","ğŸ–","ğŸ§¹","ğŸ’Š","ğŸ§´","ğŸ·","ğŸ§ƒ","ğŸ¥š","ğŸ§€","ğŸ«","â˜•","ğŸ§¼","ğŸ›’","â„ï¸","ğŸŒ¿","ğŸ¥©","ğŸ«™","ğŸŸ","ğŸ§ˆ","ğŸ«","ğŸ¥£","ğŸ§‚","ğŸ«’"];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let categories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
let needed     = {};
let emailTo    = localStorage.getItem('fridge-email') || 'you@example.com';
let editMode   = false;
let currentView = 'grid';
let suppressFbUpdate = false;

// Edit context
let selectedCatId  = null;
let catModalMode   = 'new'; // 'new' | 'edit'
let editingCatId   = null;
let editingItemCatId = null;
let editingItemOld   = null;
let deleteCatId    = null;
let deleteItemCatId = null;
let deleteItemName  = null;
let catFormColor   = '#4ECDC4';
let catFormEmoji   = 'ğŸ›’';

// â”€â”€ Firebase boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initFirebase() {
  window._fbListen('categories', val => {
    if (val) { categories = val; renderAll(); }
    else      { saveCats(); }
  });
  window._fbListen('needed', val => {
    needed = val || {};
    renderAll();
  });
}

if (window._fbReady) initFirebase();
else window._onFbReady = initFirebase;

// â”€â”€ Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveCats()   { window._fbSet('categories', categories); }
function saveNeeded() { window._fbSet('needed', needed); }

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() {
  renderGrid();
  renderList();
  renderSend();
  renderHeader();
}

function renderHeader() {
  const count = Object.values(needed).filter(Boolean).length;
  document.getElementById('count-label').textContent = count === 0 ? 'All stocked up!' : `${count} item${count !== 1 ? 's' : ''} needed`;
  const sendBtn = document.getElementById('send-btn');
  sendBtn.style.background = count > 0 ? '#22c55e' : '#1a1a1a';
  sendBtn.style.color = count > 0 ? '#fff' : '#444';
}

function renderGrid() {
  const container = document.getElementById('categories-container');
  container.innerHTML = '';
  categories.forEach(cat => {
    const section = document.createElement('div');
    section.className = 'cat-section';
    section.innerHTML = `
      <div class="cat-header">
        <div class="cat-label" style="color:${cat.color}">${cat.emoji} ${cat.label}</div>
        <div class="cat-edit-btns">
          <button class="cat-edit-btn" style="color:#aaa" onclick="openEditCat('${cat.id}')">âœï¸</button>
          <button class="cat-edit-btn" style="color:#ef4444" onclick="openDeleteCat('${cat.id}')">ğŸ—‘</button>
        </div>
      </div>
      <div class="tiles" id="tiles-${cat.id}"></div>
    `;
    const tilesEl = section.querySelector(`#tiles-${cat.id}`);
    cat.items.forEach(item => {
      const wrap = document.createElement('div');
      wrap.className = 'tile-wrap';
      const active = !!needed[item];
      const tile = document.createElement('button');
      tile.className = 'tile' + (active ? ' active' : '');
      tile.style.background = active ? cat.color : '#1c1c1c';
      tile.style.boxShadow  = active ? `0 3px 14px ${cat.color}44` : 'none';
      tile.style.borderColor = active ? 'transparent' : '#252525';
      tile.innerHTML = `${escHtml(item)}${active ? ' <span>âœ“</span>' : ''}`;
      tile.onclick = () => toggleItem(item);
      wrap.appendChild(tile);
      // Edit/delete icons
      const editBtn = document.createElement('button');
      editBtn.className = 'tile-icon-btn tile-edit';
      editBtn.textContent = 'âœï¸';
      editBtn.onclick = (e) => { e.stopPropagation(); openEditItem(cat.id, item); };
      const delBtn = document.createElement('button');
      delBtn.className = 'tile-icon-btn tile-del';
      delBtn.textContent = 'ğŸ—‘';
      delBtn.onclick = (e) => { e.stopPropagation(); openDeleteItem(cat.id, item); };
      wrap.appendChild(editBtn);
      wrap.appendChild(delBtn);
      tilesEl.appendChild(wrap);
    });
    container.appendChild(section);
  });
  // Apply edit mode classes
  document.querySelectorAll('.cat-edit-btns, .tile-icon-btn').forEach(el => {
    if (editMode) el.classList.add('edit-mode-show');
  });
  if (editMode) container.classList.add('edit-mode');
  else container.classList.remove('edit-mode');
}

function renderList() {
  const container = document.getElementById('list-container');
  const title = document.getElementById('list-title');
  const neededItems = categories.flatMap(cat => cat.items.filter(i => needed[i]).map(i => ({ item: i, cat })));
  title.textContent = neededItems.length === 0 ? 'Nothing needed yet' : 'Shopping List';
  container.innerHTML = '';
  if (neededItems.length === 0) {
    container.innerHTML = '<p style="color:#444;font-size:13px;">Tap items in grid view to add them here.</p>';
    return;
  }
  neededItems.forEach(({ item, cat }) => {
    const row = document.createElement('div');
    row.className = 'list-item';
    row.style.borderLeft = `4px solid ${cat.color}`;
    row.innerHTML = `
      <div>
        <div class="list-item-name">${escHtml(item)}</div>
        <div class="list-item-cat">${cat.emoji} ${escHtml(cat.label)}</div>
      </div>
      <button class="got-it-btn" onclick="toggleItem('${escHtml(item)}')">Got it âœ“</button>
    `;
    container.appendChild(row);
  });
}

function renderSend() {
  const container = document.getElementById('send-list-container');
  container.innerHTML = '';
  let hasItems = false;
  categories.forEach(cat => {
    const items = cat.items.filter(i => needed[i]);
    if (!items.length) return;
    hasItems = true;
    const section = document.createElement('div');
    section.className = 'send-section';
    section.innerHTML = `<div class="send-cat-label" style="color:${cat.color}">${cat.emoji} ${escHtml(cat.label)}</div>`;
    items.forEach(item => {
      const row = document.createElement('div');
      row.className = 'send-item-row';
      row.innerHTML = `<span>â€¢ ${escHtml(item)}</span><button class="send-remove" onclick="toggleItem('${escHtml(item)}')">âœ•</button>`;
      section.appendChild(row);
    });
    container.appendChild(section);
  });
  if (!hasItems) container.innerHTML = '<p style="color:#444;font-size:13px;">Nothing on the list yet.</p>';
  document.getElementById('email-input').value = emailTo;
}

// â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleItem(item) {
  if (editMode) return;
  needed[item] = !needed[item];
  saveNeeded();
  renderAll();
}

function toggleEditMode() {
  editMode = !editMode;
  const btn = document.getElementById('edit-toggle-btn');
  const banner = document.getElementById('edit-banner');
  const viewToggle = document.getElementById('view-toggle-btn');
  const sendBtnEl = document.getElementById('send-btn');
  if (editMode) {
    btn.textContent = 'âœ“ Done';
    btn.style.background = '#f97316';
    btn.style.color = '#fff';
    banner.classList.add('visible');
    viewToggle.style.display = 'none';
    sendBtnEl.style.display = 'none';
    showView('grid');
  } else {
    btn.textContent = 'âœï¸ Edit';
    btn.style.background = '#1a1a1a';
    btn.style.color = '#666';
    banner.classList.remove('visible');
    viewToggle.style.display = '';
    sendBtnEl.style.display = '';
  }
  renderGrid();
}

function toggleView() {
  showView(currentView === 'grid' ? 'list' : 'grid');
  document.getElementById('view-toggle-btn').textContent = currentView === 'list' ? 'âŠ' : 'â‰¡';
}

function showView(v) {
  currentView = v;
  document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  document.getElementById(`${v}-view`).classList.add('active');
  if (v === 'send') renderSend();
}

// â”€â”€ Add Item â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddItem() {
  selectedCatId = categories[0]?.id || null;
  document.getElementById('new-item-input').value = '';
  renderCatChips();
  updateAddBtn();
  openModal('modal-addItem');
  setTimeout(() => document.getElementById('new-item-input').focus(), 100);
}

function renderCatChips() {
  const container = document.getElementById('cat-chips-container');
  container.innerHTML = '';
  categories.forEach(cat => {
    const btn = document.createElement('button');
    btn.className = 'cat-chip' + (selectedCatId === cat.id ? ' selected' : '');
    if (selectedCatId === cat.id) { btn.style.background = cat.color; btn.style.borderColor = cat.color; }
    btn.textContent = `${cat.emoji} ${cat.label}`;
    btn.onclick = () => { selectedCatId = cat.id; renderCatChips(); updateAddBtn(); };
    container.appendChild(btn);
  });
  const newBtn = document.createElement('button');
  newBtn.className = 'cat-chip-new';
  newBtn.textContent = '+ New category';
  newBtn.onclick = () => { closeModal('modal-addItem'); catModalMode = 'new'; openCatModal(); };
  container.appendChild(newBtn);
}

function updateAddBtn() {
  const val = document.getElementById('new-item-input').value.trim();
  const btn = document.getElementById('add-item-confirm-btn');
  const ok = val && selectedCatId;
  btn.style.background = ok ? '#f97316' : '#1c1c1c';
  btn.style.color = ok ? '#fff' : '#333';
}

function confirmAddItem() {
  const val = document.getElementById('new-item-input').value.trim();
  if (!val || !selectedCatId) return;
  const names = val.split(',').map(s => s.trim()).filter(Boolean);
  categories = categories.map(c => c.id === selectedCatId ? { ...c, items: [...c.items, ...names] } : c);
  names.forEach(name => { needed[name] = true; });
  saveCats(); saveNeeded();
  closeModal('modal-addItem');
  renderAll();
}

// â”€â”€ Category modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCatModal() {
  document.getElementById('cat-modal-title').textContent = catModalMode === 'new' ? 'New Category' : 'Edit Category';
  document.getElementById('cat-back-btn').textContent = catModalMode === 'new' ? 'â† Back' : 'Cancel';
  document.getElementById('cat-back-btn').onclick = catModalMode === 'new'
    ? () => { closeModal('modal-editCat'); openAddItem(); }
    : () => closeModal('modal-editCat');
  document.getElementById('cat-confirm-btn').textContent = catModalMode === 'new' ? 'Create' : 'Save changes';
  if (catModalMode === 'new') { document.getElementById('cat-name-input').value = ''; catFormEmoji = 'ğŸ›’'; catFormColor = '#4ECDC4'; }
  renderEmojiGrid();
  renderPalette();
  updateCatPreview();
  openModal('modal-editCat');
  setTimeout(() => document.getElementById('cat-name-input').focus(), 100);
}

function openEditCat(catId) {
  const cat = categories.find(c => c.id === catId);
  if (!cat) return;
  catModalMode = 'edit'; editingCatId = catId;
  catFormEmoji = cat.emoji; catFormColor = cat.color;
  document.getElementById('cat-name-input').value = cat.label;
  openCatModal();
}

function renderEmojiGrid() {
  const grid = document.getElementById('emoji-grid');
  grid.innerHTML = '';
  EMOJIS.forEach(e => {
    const btn = document.createElement('button');
    btn.className = 'emoji-btn' + (catFormEmoji === e ? ' selected' : '');
    btn.textContent = e;
    btn.onclick = () => { catFormEmoji = e; renderEmojiGrid(); updateCatPreview(); };
    grid.appendChild(btn);
  });
}

function renderPalette() {
  const grid = document.getElementById('palette-grid');
  grid.innerHTML = '';
  PALETTE.forEach(c => {
    const btn = document.createElement('button');
    btn.className = 'swatch' + (catFormColor === c ? ' selected' : '');
    btn.style.background = c;
    btn.onclick = () => { catFormColor = c; renderPalette(); updateCatPreview(); };
    grid.appendChild(btn);
  });
}

function updateCatPreview() {
  const name = document.getElementById('cat-name-input').value || 'Preview';
  const preview = document.getElementById('cat-preview');
  preview.style.borderLeft = `4px solid ${catFormColor}`;
  preview.style.background = '#0f0f0f';
  document.getElementById('cat-preview-text').textContent = `${catFormEmoji} ${name}`;
  document.getElementById('cat-preview-text').style.color = catFormColor;
  document.getElementById('cat-preview-text').style.fontWeight = '800';
  document.getElementById('cat-preview-text').style.fontSize = '13px';
  const btn = document.getElementById('cat-confirm-btn');
  btn.style.background = name && name !== 'Preview' ? catFormColor : '#1c1c1c';
  btn.style.color = name && name !== 'Preview' ? '#fff' : '#333';
}

function confirmCat() {
  const label = document.getElementById('cat-name-input').value.trim();
  if (!label) return;
  if (catModalMode === 'new') {
    const id = 'cat_' + Date.now();
    categories = [...categories, { id, label, emoji: catFormEmoji, color: catFormColor, items: [] }];
  } else {
    categories = categories.map(c => c.id === editingCatId ? { ...c, label, emoji: catFormEmoji, color: catFormColor } : c);
  }
  saveCats();
  closeModal('modal-editCat');
  renderAll();
}

// â”€â”€ Edit Item â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openEditItem(catId, item) {
  editingItemCatId = catId;
  editingItemOld = item;
  document.getElementById('edit-item-input').value = item;
  updateEditItemBtn();
  openModal('modal-editItem');
  setTimeout(() => document.getElementById('edit-item-input').focus(), 100);
}

function updateEditItemBtn() {
  const val = document.getElementById('edit-item-input').value.trim();
  document.getElementById('edit-item-confirm-btn').style.background = val ? '#4ECDC4' : '#1c1c1c';
}

function confirmEditItem() {
  const newName = document.getElementById('edit-item-input').value.trim();
  if (!newName || !editingItemCatId) return;
  categories = categories.map(c => {
    if (c.id !== editingItemCatId) return c;
    return { ...c, items: c.items.map(i => i === editingItemOld ? newName : i) };
  });
  if (needed[editingItemOld] !== undefined) { needed[newName] = needed[editingItemOld]; delete needed[editingItemOld]; }
  saveCats(); saveNeeded();
  closeModal('modal-editItem');
  renderAll();
}

// â”€â”€ Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openDeleteCat(catId) {
  const cat = categories.find(c => c.id === catId);
  if (!cat) return;
  deleteCatId = catId;
  document.getElementById('delete-cat-msg').innerHTML = `This will permanently remove <strong style="color:${cat.color}">${cat.emoji} ${escHtml(cat.label)}</strong> and all ${cat.items.length} item${cat.items.length !== 1 ? 's' : ''} inside it.`;
  document.getElementById('delete-cat-preview').innerHTML = cat.items.map(i => `<div class="delete-preview-item">â€¢ ${escHtml(i)}</div>`).join('');
  document.getElementById('delete-cat-preview').style.borderLeft = `3px solid ${cat.color}`;
  openModal('modal-deleteCat');
}

function confirmDeleteCat() {
  const cat = categories.find(c => c.id === deleteCatId);
  if (cat) cat.items.forEach(i => delete needed[i]);
  categories = categories.filter(c => c.id !== deleteCatId);
  saveCats(); saveNeeded();
  closeModal('modal-deleteCat');
  renderAll();
}

function openDeleteItem(catId, item) {
  deleteItemCatId = catId; deleteItemName = item;
  document.getElementById('delete-item-msg').innerHTML = `<strong style="color:#fff">${escHtml(item)}</strong> will be permanently removed from your list.`;
  openModal('modal-deleteItem');
}

function confirmDeleteItem() {
  categories = categories.map(c => c.id === deleteItemCatId ? { ...c, items: c.items.filter(i => i !== deleteItemName) } : c);
  delete needed[deleteItemName];
  saveCats(); saveNeeded();
  closeModal('modal-deleteItem');
  renderAll();
}

// â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openExport() {
  document.getElementById('export-textarea').value = JSON.stringify(categories, null, 2);
  document.getElementById('copy-btn').textContent = 'Copy to clipboard';
  openModal('modal-export');
}

function copyExport() {
  const text = document.getElementById('export-textarea').value;
  const btn = document.getElementById('copy-btn');
  const fallback = () => {
    const ta = document.createElement('textarea');
    ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
    document.body.appendChild(ta); ta.focus(); ta.select();
    try { document.execCommand('copy'); } catch {}
    document.body.removeChild(ta);
    btn.textContent = 'âœ“ Copied!'; setTimeout(() => btn.textContent = 'Copy to clipboard', 2000);
  };
  if (navigator.clipboard?.writeText) {
    navigator.clipboard.writeText(text).then(() => { btn.textContent = 'âœ“ Copied!'; setTimeout(() => btn.textContent = 'Copy to clipboard', 2000); }).catch(fallback);
  } else fallback();
}

// â”€â”€ Email â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openMailto() {
  emailTo = document.getElementById('email-input').value;
  localStorage.setItem('fridge-email', emailTo);
  const grouped = categories
    .map(c => ({ c, items: c.items.filter(i => needed[i]) }))
    .filter(g => g.items.length)
    .map(g => `${g.c.emoji} ${g.c.label}:\n${g.items.map(i => `  â€¢ ${i}`).join('\n')}`)
    .join('\n\n');
  const subject = encodeURIComponent('ğŸ›’ Shopping List');
  const body = encodeURIComponent(`Hi,\n\nHere's what we need:\n\n${grouped}\n\nHave a great shop!`);
  window.open(`mailto:${emailTo}?subject=${subject}&body=${body}`, '_blank');
  needed = {};
  saveNeeded();
  showView('grid');
}

// â”€â”€ Modal helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id)  { document.getElementById(id).style.display = 'flex'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function overlayClick(e, id) { if (e.target === e.currentTarget) closeModal(id); }

// â”€â”€ Util â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>

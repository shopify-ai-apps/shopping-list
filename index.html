<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0f0f0f">
  <title>ğŸ›’ Need to Buy</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { background: #0f0f0f; color: #fff; font-family: 'Nunito', 'Trebuchet MS', sans-serif; min-height: 100vh; user-select: none; }
    button { font-family: inherit; }
    input, textarea { font-family: inherit; outline: none; }

    /* Header */
    #header { display: flex; align-items: center; justify-content: space-between; padding: 18px 20px 12px; border-bottom: 1px solid #1a1a1a; position: sticky; top: 0; background: #0f0f0f; z-index: 10; }
    #header-left h1 { font-size: 22px; font-weight: 900; letter-spacing: -0.5px; }
    #header-left p { font-size: 12px; color: #555; margin-top: 2px; }
    #header-right { display: flex; gap: 7px; }
    .hbtn { border: none; border-radius: 10px; padding: 8px 13px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s; }

    /* Edit banner */
    #edit-banner { background: #1a1000; border-bottom: 1px solid #3a2800; padding: 8px 20px; font-size: 12px; color: #f97316; display: none; align-items: center; justify-content: space-between; }
    #edit-banner.visible { display: flex; }
    #export-btn { background: #2a1800; border: 1px solid #f97316; border-radius: 8px; padding: 5px 10px; color: #f97316; font-size: 12px; font-weight: 700; cursor: pointer; }

    /* Sync indicator */
    #sync-bar { background: #0a1a0a; border-bottom: 1px solid #1a3a1a; padding: 5px 20px; font-size: 11px; color: #22c55e; display: none; }
    #sync-bar.visible { display: block; }

    /* Views */
    .view { display: none; padding: 14px 18px; }
    .view.active { display: block; }

    /* Grid */
    .cat-section { margin-bottom: 24px; }
    .cat-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 9px; }
    .cat-label { font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; }
    .cat-edit-btns { display: none; gap: 5px; }
    .edit-mode .cat-edit-btns { display: flex; }
    .cat-edit-btn { background: #1c1c1c; border: none; border-radius: 7px; padding: 5px 9px; font-size: 15px; cursor: pointer; line-height: 1; }

    .tiles { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .tile-wrap { position: relative; }
    .tile {
      width: 100%; background: #1c1c1c; border: 2px solid #252525; border-radius: 14px;
      padding: 16px 10px; color: #666; font-size: 13px; font-weight: 600; cursor: pointer;
      text-align: center; transition: all 0.13s ease; line-height: 1.3; display: flex;
      align-items: center; justify-content: center; gap: 5px; min-height: 58px;
    }
    .tile.active { color: #fff; font-weight: 800; border-color: transparent; }
    .tile.tapped { transform: scale(0.91); }
    .tile-icon-btn {
      position: absolute; bottom: 4px; background: rgba(30,30,30,0.92);
      border: none; border-radius: 6px; width: 26px; height: 26px;
      font-size: 12px; cursor: pointer; display: none; align-items: center; justify-content: center;
    }
    .tile-edit { left: 4px; color: #ccc; }
    .tile-del  { right: 4px; color: #ef4444; }
    .edit-mode .tile-icon-btn { display: flex; }

    .add-item-btn { background: none; border: 2px dashed #252525; border-radius: 12px; padding: 12px 18px; color: #3a3a3a; font-size: 13px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 2px; }

    /* List view */
    .list-item { display: flex; align-items: center; justify-content: space-between; background: #181818; border-radius: 11px; padding: 12px 14px; margin-bottom: 6px; }
    .list-item-name { color: #eee; font-size: 14px; }
    .list-item-cat { color: #3a3a3a; font-size: 11px; margin-top: 2px; }
    .got-it-btn { background: #252525; border: none; border-radius: 7px; padding: 5px 10px; color: #888; cursor: pointer; font-size: 11px; }

    /* Send view */
    .send-card { background: #181818; border-radius: 16px; padding: 18px; }
    .send-section { margin-bottom: 12px; }
    .send-cat-label { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
    .send-item-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #222; color: #ccc; font-size: 13px; }
    .send-remove { background: none; border: none; color: #3a3a3a; cursor: pointer; font-size: 14px; }
    .send-email-label { font-size: 11px; color: #444; display: block; margin: 14px 0 5px; }
    .send-email-input { width: 100%; background: #111; border: 1px solid #252525; border-radius: 9px; padding: 10px 13px; color: #fff; font-size: 14px; margin-bottom: 12px; }
    .send-btn { width: 100%; background: #22c55e; border: none; border-radius: 11px; padding: 13px; color: #fff; font-size: 15px; font-weight: 800; cursor: pointer; }
    .back-btn { background: none; border: none; color: #777; font-size: 13px; cursor: pointer; margin-bottom: 12px; }

    /* Overlay / Sheet */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.88); display: flex; align-items: flex-end; z-index: 200; }
    .sheet { background: #161616; border-radius: 22px 22px 0 0; padding: 22px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .sheet-title { font-size: 16px; font-weight: 800; margin-bottom: 16px; }
    .sheet-label { font-size: 11px; color: #555; display: block; margin-bottom: 6px; }
    .sheet-input { width: 100%; background: #0f0f0f; border: 1px solid #252525; border-radius: 9px; padding: 11px 13px; color: #fff; font-size: 15px; margin-bottom: 16px; }
    .sheet-textarea { width: 100%; background: #0a0a0a; border: 1px solid #252525; border-radius: 9px; padding: 11px 13px; color: #888; font-size: 11px; font-family: monospace; height: 200px; resize: none; }
    .sheet-btns { display: flex; gap: 8px; margin-top: 12px; }
    .btn-secondary { flex: 1; background: #1c1c1c; border: none; border-radius: 11px; padding: 13px; color: #888; font-size: 14px; cursor: pointer; }
    .btn-primary   { flex: 2; border: none; border-radius: 11px; padding: 13px; color: #fff; font-size: 14px; font-weight: 800; cursor: pointer; }
    .btn-danger    { flex: 2; background: #ef4444; border: none; border-radius: 11px; padding: 13px; color: #fff; font-size: 14px; font-weight: 800; cursor: pointer; }

    /* Cat chips */
    .cat-chips { display: flex; flex-wrap: wrap; gap: 7px; margin-bottom: 18px; }
    .cat-chip { border: 2px solid #252525; border-radius: 8px; padding: 6px 12px; color: #666; font-size: 12px; font-weight: 700; cursor: pointer; background: #1c1c1c; }
    .cat-chip.selected { border-color: transparent; color: #fff; }
    .cat-chip-new { background: none; border: 2px dashed #252525; border-radius: 8px; padding: 6px 12px; color: #444; font-size: 12px; font-weight: 700; cursor: pointer; }

    /* Emoji / palette pickers */
    .emoji-grid { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 16px; }
    .emoji-btn { background: none; border: 2px solid transparent; border-radius: 7px; padding: 4px 7px; font-size: 19px; cursor: pointer; }
    .emoji-btn.selected { background: #2a2a2a; border-color: #555; }
    .palette-grid { display: flex; flex-wrap: wrap; gap: 7px; margin-bottom: 16px; }
    .swatch { width: 30px; height: 30px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; }
    .swatch.selected { border-color: #fff; }
    .cat-preview { border-radius: 9px; padding: 9px 13px; margin-bottom: 18px; }

    /* Delete confirm list */
    .delete-preview { background: #0f0f0f; border-radius: 10px; padding: 10px 14px; margin-bottom: 18px; }
    .delete-preview-item { font-size: 12px; color: #555; padding: 2px 0; }

    /* PIN screen */
    #pin-screen { position: fixed; inset: 0; background: #0f0f0f; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 24px; }
    #pin-screen h2 { font-size: 22px; font-weight: 900; color: #fff; }
    #pin-screen p  { font-size: 13px; color: #555; margin-top: -16px; }
    .pin-dots { display: flex; gap: 14px; }
    .pin-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #333; background: transparent; transition: all 0.15s; }
    .pin-dot.filled { background: #4ECDC4; border-color: #4ECDC4; }
    .pin-dot.error  { background: #ef4444; border-color: #ef4444; }
    .pin-keypad { display: grid; grid-template-columns: repeat(3, 72px); gap: 12px; }
    .pin-key { width: 72px; height: 72px; border-radius: 50%; border: none; background: #1c1c1c; color: #fff; font-size: 22px; font-weight: 700; cursor: pointer; transition: all 0.1s; display: flex; align-items: center; justify-content: center; }
    .pin-key:active { background: #2a2a2a; transform: scale(0.93); }
    .pin-key.del { background: none; color: #555; font-size: 18px; }
    .pin-error-msg { font-size: 13px; color: #ef4444; height: 18px; }
  </style>
</head>
<body>

<!-- PIN SCREEN -->
<div id="pin-screen">
  <h2>ğŸ›’ Need to Buy</h2>
  <p>Enter PIN to continue</p>
  <div class="pin-dots">
    <div class="pin-dot" id="dot-0"></div>
    <div class="pin-dot" id="dot-1"></div>
    <div class="pin-dot" id="dot-2"></div>
    <div class="pin-dot" id="dot-3"></div>
  </div>
  <div class="pin-error-msg" id="pin-error"></div>
  <div class="pin-keypad">
    <button class="pin-key" onclick="pinPress('1')">1</button>
    <button class="pin-key" onclick="pinPress('2')">2</button>
    <button class="pin-key" onclick="pinPress('3')">3</button>
    <button class="pin-key" onclick="pinPress('4')">4</button>
    <button class="pin-key" onclick="pinPress('5')">5</button>
    <button class="pin-key" onclick="pinPress('6')">6</button>
    <button class="pin-key" onclick="pinPress('7')">7</button>
    <button class="pin-key" onclick="pinPress('8')">8</button>
    <button class="pin-key" onclick="pinPress('9')">9</button>
    <button class="pin-key" style="visibility:hidden"></button>
    <button class="pin-key" onclick="pinPress('0')">0</button>
    <button class="pin-key del" onclick="pinDelete()">âŒ«</button>
  </div>
</div>

<!-- HEADER -->
<div id="header">
  <div id="header-left">
    <h1>ğŸ›’ Need to Buy</h1>
    <p id="count-label">All stocked up!</p>
  </div>
  <div id="header-right">
    <button class="hbtn" id="edit-toggle-btn" style="background:#1a1a1a;color:#666;" onclick="toggleEditMode()">âœï¸ Edit</button>
    <button class="hbtn" id="view-toggle-btn" style="background:#1a1a1a;color:#777;font-size:16px;" onclick="toggleView()">â‰¡</button>
    <button class="hbtn" id="send-btn" style="background:#1a1a1a;color:#444;" onclick="showView('send')">ğŸ’¬ Send</button>
  </div>
</div>

<!-- EDIT BANNER -->
<div id="edit-banner">
  <span>âœï¸ Tap âœï¸ to rename, ğŸ—‘ to delete.</span>
  <button id="export-btn" onclick="openExport()">ğŸ“¤ Export</button>
</div>

<!-- SYNC BAR -->
<div id="sync-bar">âš¡ Live sync active â€” changes appear on all devices instantly</div>

<!-- GRID VIEW -->
<div id="grid-view" class="view active">
  <div id="categories-container"></div>
  <button class="add-item-btn" onclick="openAddItem()">+ Add item or category</button>
</div>

<!-- LIST VIEW -->
<div id="list-view" class="view">
  <h2 style="font-size:16px;font-weight:800;margin-bottom:12px;" id="list-title">Shopping List</h2>
  <div id="list-container"></div>
</div>

<!-- SEND VIEW -->
<div id="send-view" class="view">
  <button class="back-btn" onclick="showView('grid')">â† Back</button>
  <div class="send-card">
    <h2 style="font-size:16px;font-weight:800;margin-bottom:12px;">Review & Send</h2>
    <div id="send-list-container"></div>
    <button class="send-btn" style="background:#25D366;margin-top:14px;" onclick="openWhatsApp()">ğŸ’¬ Send via WhatsApp</button>
    <p style="margin-top:8px;color:#444;text-align:center;font-size:11px;">Opens WhatsApp with the list pre-filled. List will clear after tapping.</p>
  </div>
</div>

<!-- â•â• MODALS â•â• -->

<!-- Add Item -->
<div class="overlay" id="modal-addItem" style="display:none" onclick="overlayClick(event,'modal-addItem')">
  <div class="sheet">
    <div class="sheet-title">Add items</div>
    <label class="sheet-label">Separate multiple items with commas</label>
    <input class="sheet-input" id="new-item-input" placeholder="e.g. Oat milk, Yoghurt, Butter" oninput="updateAddBtn()" onkeydown="if(event.key==='Enter')confirmAddItem()">
    <label class="sheet-label">Category</label>
    <div class="cat-chips" id="cat-chips-container"></div>
    <div class="sheet-btns">
      <button class="btn-secondary" onclick="closeModal('modal-addItem')">Cancel</button>
      <button class="btn-primary" id="add-item-confirm-btn" style="background:#1c1c1c;color:#333;" onclick="confirmAddItem()">Add âœ“</button>
    </div>
  </div>
</div>

<!-- New / Edit Category -->
<div class="overlay" id="modal-editCat" style="display:none" onclick="overlayClick(event,'modal-editCat')">
  <div class="sheet">
    <div class="sheet-title" id="cat-modal-title">New Category</div>
    <label class="sheet-label">Name</label>
    <input class="sheet-input" id="cat-name-input" placeholder="e.g. Frozen Foods" oninput="updateCatPreview()" onkeydown="if(event.key==='Enter')confirmCat()">
    <label class="sheet-label">Emoji</label>
    <div class="emoji-grid" id="emoji-grid"></div>
    <label class="sheet-label">Colour</label>
    <div class="palette-grid" id="palette-grid"></div>
    <div class="cat-preview" id="cat-preview"><span id="cat-preview-text"></span></div>
    <div class="sheet-btns">
      <button class="btn-secondary" id="cat-back-btn" onclick="closeModal('modal-editCat')">Cancel</button>
      <button class="btn-primary" id="cat-confirm-btn" onclick="confirmCat()">Create</button>
    </div>
  </div>
</div>

<!-- Edit Item -->
<div class="overlay" id="modal-editItem" style="display:none" onclick="overlayClick(event,'modal-editItem')">
  <div class="sheet">
    <div class="sheet-title">Rename Item</div>
    <label class="sheet-label">Item name</label>
    <input class="sheet-input" id="edit-item-input" oninput="updateEditItemBtn()" onkeydown="if(event.key==='Enter')confirmEditItem()">
    <div class="sheet-btns">
      <button class="btn-secondary" onclick="closeModal('modal-editItem')">Cancel</button>
      <button class="btn-primary" id="edit-item-confirm-btn" style="background:#4ECDC4;" onclick="confirmEditItem()">Save</button>
    </div>
  </div>
</div>

<!-- Delete Category -->
<div class="overlay" id="modal-deleteCat" style="display:none" onclick="overlayClick(event,'modal-deleteCat')">
  <div class="sheet">
    <div class="sheet-title">Delete category?</div>
    <p id="delete-cat-msg" style="font-size:13px;color:#888;margin-bottom:6px;line-height:1.5;"></p>
    <div class="delete-preview" id="delete-cat-preview"></div>
    <div class="sheet-btns">
      <button class="btn-secondary" onclick="closeModal('modal-deleteCat')">Cancel</button>
      <button class="btn-danger" onclick="confirmDeleteCat()">Yes, delete category</button>
    </div>
  </div>
</div>

<!-- Delete Item -->
<div class="overlay" id="modal-deleteItem" style="display:none" onclick="overlayClick(event,'modal-deleteItem')">
  <div class="sheet">
    <div class="sheet-title">Remove item?</div>
    <p id="delete-item-msg" style="font-size:13px;color:#888;margin-bottom:18px;line-height:1.5;"></p>
    <div class="sheet-btns">
      <button class="btn-secondary" onclick="closeModal('modal-deleteItem')">Cancel</button>
      <button class="btn-danger" onclick="confirmDeleteItem()">Yes, remove item</button>
    </div>
  </div>
</div>

<!-- Export -->
<div class="overlay" id="modal-export" style="display:none" onclick="overlayClick(event,'modal-export')">
  <div class="sheet">
    <div class="sheet-title">ğŸ“¤ Export config</div>
    <p style="font-size:12px;color:#555;margin-bottom:12px;">Copy this and paste it to Claude to save as your new defaults.</p>
    <textarea class="sheet-textarea" id="export-textarea" readonly></textarea>
    <div class="sheet-btns">
      <button class="btn-secondary" onclick="closeModal('modal-export')">Close</button>
      <button class="btn-primary" id="copy-btn" style="background:#4ECDC4;" onclick="copyExport()">Copy to clipboard</button>
    </div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCJktZZkiD1rs2t9X2H-Ko-aa3joCIHCiE",
    authDomain: "shopping-list-b1bac.firebaseapp.com",
    databaseURL: "https://shopping-list-b1bac-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "shopping-list-b1bac",
    storageBucket: "shopping-list-b1bac.firebasestorage.app",
    messagingSenderId: "635263766216",
    appId: "1:635263766216:web:7909fb9784f42049069ffd"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // Expose Firebase write/listen to global scope
  window._fbSet = (path, data) => set(ref(db, path), data);
  window._fbListen = (path, cb) => onValue(ref(db, path), snap => cb(snap.val()));

  // Show sync bar once connected
  document.getElementById('sync-bar').classList.add('visible');

  // Boot app after Firebase is ready
  window._fbReady = true;
  if (window._onFbReady) window._onFbReady();
</script>

<script>
// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_CATEGORIES = [
  { id: "pet",       label: "Pet Supplies",    emoji: "ğŸ±", color: "#FF6B6B", items: ["Cat food", "Cat nibbles", "Dog biscuits", "Dog food"] },
  { id: "dairy",     label: "Dairy",           emoji: "ğŸ¥›", color: "#4ECDC4", items: ["Milk", "Yoghurt", "Cheese", "Butter", "Eggs", "Oat milk"] },
  { id: "bread",     label: "Bread & Bakery",  emoji: "ğŸ", color: "#FFD93D", items: ["White bread", "Sourdough", "Crumpets", "Bagels"] },
  { id: "snacks",    label: "Snacks & Drinks", emoji: "ğŸ¿", color: "#A855F7", items: ["Crisps", "Biscuits", "Orange juice", "Squash", "Coffee", "Tea"] },
  { id: "veg",       label: "Vegetables",      emoji: "ğŸ¥¦", color: "#6BCB77", items: ["Broccoli", "Parsnips", "Potatoes", "Cucumber", "Tomatoes", "Cauliflower"] },
  { id: "frozen",    label: "Frozen food",     emoji: "â„ï¸", color: "#4ECDC4", items: ["Chips", "Pizza", "Yorky P"] },
  { id: "tinned",    label: "Tinned food",     emoji: "ğŸ«™", color: "#8B5CF6", items: ["Tinned Toms", "Soup", "Baked beans", "Spag hoops"] },
  { id: "breakfast", label: "Breakfast",       emoji: "ğŸ¥£", color: "#EC4899", items: ["Porridge", "Hoops", "Shreddies"] },
];

const PALETTE = ["#FF6B6B","#FF9F43","#FFD93D","#6BCB77","#4ECDC4","#45B7D1","#A855F7","#EC4899","#F97316","#14B8A6","#8B5CF6","#06B6D4"];
const EMOJIS  = ["ğŸ±","ğŸ¶","ğŸ¥›","ğŸ","ğŸ¿","ğŸ¥¦","ğŸ–","ğŸ§¹","ğŸ’Š","ğŸ§´","ğŸ·","ğŸ§ƒ","ğŸ¥š","ğŸ§€","ğŸ«","â˜•","ğŸ§¼","ğŸ›’","â„ï¸","ğŸŒ¿","ğŸ¥©","ğŸ«™","ğŸŸ","ğŸ§ˆ","ğŸ«","ğŸ¥£","ğŸ§‚","ğŸ«’"];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let categories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
let needed     = {};
let emailTo    = localStorage.getItem('fridge-email') || 'you@example.com';
let editMode   = false;
let currentView = 'grid';
let suppressFbUpdate = false;

// Edit context
let selectedCatId  = null;
let catModalMode   = 'new'; // 'new' | 'edit'
let editingCatId   = null;
let editingItemCatId = null;
let editingItemOld   = null;
let deleteCatId    = null;
let deleteItemCatId = null;
let deleteItemName  = null;
let catFormColor   = '#4ECDC4';
let catFormEmoji   = 'ğŸ›’';

// â”€â”€ Firebase boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initFirebase() {
  window.